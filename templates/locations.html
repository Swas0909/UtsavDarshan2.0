<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choose Location - UtsavDarshan</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
</head>
<body>
    <header>
        <nav>
            <div class="nav-container">
                <h1>UtsavDarshan</h1>
                <a href="{{ url_for('index') }}" class="btn">Home</a>
            </div>
        </nav>
    </header>

    <main>
        <section class="location-selection">
            <h2>Find Ganapati Pandals</h2>
            <input type="text" id="search" placeholder="Search for Ganapatis or areas...">
            <div class="pandal-list">
                {% for taluka in talukas %}
                {% for pandal in taluka.pandals %}
                <div class="pandal-item" data-name="{{ pandal.name }}" data-taluka="{{ taluka.name }}">
                    <img src="{{ pandal.image }}" alt="{{ pandal.name }}">
                    <div class="pandal-info">
                        <h3>{{ pandal.name }}</h3>
                        <p>{{ taluka.name }}</p>
                        <button class="btn directions-btn" data-lat="{{ pandal.location.lat }}" data-lng="{{ pandal.location.lng }}">Get Directions</button>
                    </div>
                </div>
                {% endfor %}
                {% endfor %}
            </div>
        </section>

        <section class="map-section">
            <h2>Pandals on Map</h2>
            <div id="map" style="width: 100%; height: 400px;"></div>
        </section>
    </main>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoic3dhczEyMzQiLCJhIjoiY21mMnQ5Yjd4MGNsYjJqczVmYTBxd2doaSJ9.tL2Iht77YAWgCQCS5zgCLA';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/swas1234/cmf5owmxi00k001pl5u71czpt',
            center: [72.8777, 19.0760], // Mumbai center
            zoom: 10
        });

        const talukasData = JSON.parse('{{ talukas|tojson }}');
        let allPandals = [];
        talukasData.forEach(taluka => {
            taluka.pandals.forEach(pandal => {
                allPandals.push({ ...pandal, taluka: taluka.name });
            });
        });

        // Add all markers initially
        allPandals.forEach(pandal => {
            new mapboxgl.Marker()
                .setLngLat([pandal.location.lng, pandal.location.lat])
                .setPopup(new mapboxgl.Popup().setHTML(`<h3>${pandal.name}</h3><p>${pandal.history}</p>`))
                .addTo(map);
        });

        // Search functionality
        const searchInput = document.getElementById('search');
        const pandalItems = document.querySelectorAll('.pandal-item');

        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            pandalItems.forEach(item => {
                const name = item.getAttribute('data-name').toLowerCase();
                const taluka = item.getAttribute('data-taluka').toLowerCase();
                if (name.includes(query) || taluka.includes(query)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // Directions buttons
        const directionsButtons = document.querySelectorAll('.directions-btn');
        directionsButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const lat = btn.getAttribute('data-lat');
                const lng = btn.getAttribute('data-lng');
                const url = `https://www.google.com/maps?q=${lat},${lng}`;
                window.open(url, '_blank');
            });
        });
    </script>
</body>
</html>
